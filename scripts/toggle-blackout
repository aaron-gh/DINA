#!/bin/bash

STATE_FILE="/tmp/screen_blanked"
LOG_FILE="/tmp/screen_blackout.log"
DISPLAYS=$(xrandr --current | awk '/ connected/{print $1}')

log_error() {
    echo "[$(date)] ERROR: $1" >> "$LOG_FILE"
    play -nq synth 0.2 sin 300 vol 0.5
    yad --title="Blackout Error" --text-info --filename="$LOG_FILE" --width=600 --height=400 &
    spd-say "Screen blackout failed. See error log."
    exit 1
}

play_on() {
    play -nq synth 0.1 sin 880 vol 0.4 &
    spd-say "Screen on" &
}

play_off() {
    play -nq synth 0.1 sin 440 vol 0.4 &
    spd-say "Screen off" &
}

if [ -z "$DISPLAYS" ]; then
    log_error "No connected displays found via xrandr"
fi

if [ -f "$STATE_FILE" ]; then
    while read -r line; do
        display=$(echo "$line" | cut -d'|' -f1)
        mode=$(echo "$line" | cut -d'|' -f2)
        xrandr --output "$display" --mode "$mode" 2>>"$LOG_FILE" || log_error "Failed to restore $display to $mode"
    done < "$STATE_FILE"
    rm -f "$STATE_FILE"
    play_on
else
    > "$STATE_FILE"
    for display in $DISPLAYS; do
        mode=$(xrandr --query | grep -A1 "^$display connected" | awk 'NR==2 {print $1}')
        [ -z "$mode" ] && log_error "Could not determine mode for $display"
        echo "$display|$mode" >> "$STATE_FILE"
        xrandr --output "$display" --off 2>>"$LOG_FILE" || log_error "Failed to turn off $display"
    done
    play_off
fi
